(subdomain-log) {
	log {
		hostnames {args[0]}
		output file /var/log/{args[0]}.log
                roll_size 1gb
                roll_keep 5
                roll_keep_for 720h
	}
}
*.$DOMAIN_NAME:443 {
	tls {
		dns cloudflare {$CLOUDFLARE_API_TOKEN}
		resolvers 1.1.1.1
	}
        import subdomain-log *.$DOMAIN_NAME
	@apiValidApiKey {
		host {$API_SUBDOMAIN}.{$DOMAIN_NAME}
		header Authorization "Bearer {$OLLAMA_API_KEY}"
	}

	@api {
		host {$API_SUBDOMAIN}.{$DOMAIN_NAME}
	}

	handle @apiValidApiKey {
		reverse_proxy {$OLLAMA_URL}
	}

	handle @api {
		header Content-Type application/json
		root * /srv
		rewrite * /401.json
		file_server
	}

	@app host {$APP_SUBDOMAIN}.{$DOMAIN_NAME}
	reverse_proxy @app {$WEBUI_SERVICE_NAME}:8080

	log
}

{$APP_SUBDOMAIN}.{$DOMAIN_NAME} {
	tls {
		dns cloudflare {$CLOUDFLARE_API_TOKEN}
		resolvers 1.1.1.1
	}
    import subdomain-log *.$DOMAIN_NAME
    reverse_proxy {$WEBUI_SERVICE_NAME}:3000
}

{$API_SUBDOMAIN}.{$DOMAIN_NAME} {
	tls {
		dns cloudflare {$CLOUDFLARE_API_TOKEN}
		resolvers 1.1.1.1
	}
    import subdomain-log *.$DOMAIN_NAME
    reverse_proxy {$LLM_SERVICE_NAME}:4000
}
